# WildVoice é¡¹ç›®å­¦ä¹ çŸ¥è¯†ç‚¹æ€»ç»“

## ğŸ“… å­¦ä¹ æ—¥æœŸ
2025å¹´10æœˆ5æ—¥

---

## ğŸ“š æ ¸å¿ƒæŠ€æœ¯æ ˆ

### 1. Next.js 15 (App Router)
- **é¡¹ç›®ç»“æ„**
  - `src/app/` - App Router é¡µé¢å’Œ API
  - `src/app/api/` - API Routes
  - `src/components/` - å…±äº«ç»„ä»¶
  - `src/lib/` - å·¥å…·å‡½æ•°
  - `src/modules/` - åŠŸèƒ½æ¨¡å—

- **API Routes åŸºç¡€**
  ```typescript
  // src/app/api/example/route.ts
  export async function GET(request: Request) {
    return new Response(JSON.stringify({ data: "hello" }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  export async function POST(request: Request) {
    const body = await request.json();
    return new Response(JSON.stringify({ success: true }));
  }
  ```

- **åŠ¨æ€è·¯ç”±**
  ```typescript
  // src/app/api/audio/[key]/route.ts
  export async function GET(
    request: Request,
    { params }: { params: { key: string } }
  ) {
    const key = params.key;
    // å¤„ç†é€»è¾‘
  }
  ```

---

### 2. Drizzle ORM (æ•°æ®åº“)

#### **Schema å®šä¹‰**
```typescript
import { integer, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const voicesSchema = sqliteTable("voices", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  userId: text("user_id").references(() => user.id, { onDelete: "cascade" }),
  createdAt: integer("created_at", { mode: "timestamp" }).defaultNow().notNull(),
});
```

#### **å…³é”®æ¦‚å¿µ**
- **å­—æ®µç±»å‹**: `text()`, `integer()`, `integer({ mode: "boolean" })`, `integer({ mode: "timestamp" })`
- **çº¦æŸ**: `.notNull()`, `.primaryKey()`, `.default()`, `.unique()`
- **å¤–é”®**: `.references(() => å…¶ä»–è¡¨.id, { onDelete: "cascade" })`
- **è‡ªåŠ¨æ—¶é—´**: `.defaultNow()`, `.$onUpdate(() => new Date())`

#### **Zod éªŒè¯é›†æˆ**
```typescript
import { createInsertSchema, createSelectSchema } from "drizzle-zod";
import { z } from "zod";

export const insertVoiceSchema = createInsertSchema(voicesSchema, {
  name: z.string().min(1, "åç§°ä¸èƒ½ä¸ºç©º").max(100, "åç§°è¿‡é•¿"),
  rating: z.number().min(0).max(5).optional(),
});

export type Voice = typeof voicesSchema.$inferSelect;
export type NewVoice = typeof voicesSchema.$inferInsert;
```

#### **æ•°æ®åº“æ“ä½œ**
```typescript
import { getDb } from "@/db";
import { eq, or } from "drizzle-orm";

const db = await getDb();

// æŸ¥è¯¢
const voices = await db.select().from(voicesSchema).where(
  eq(voicesSchema.userId, userId)
);

// æ’å…¥
const [newVoice] = await db.insert(voicesSchema).values({
  name: "Trump",
  userId: "123"
}).returning();

// æ›´æ–°
await db.update(voicesSchema).set({ name: "New Name" }).where(
  eq(voicesSchema.id, 1)
);

// åˆ é™¤
await db.delete(voicesSchema).where(eq(voicesSchema.id, 1));
```

#### **Migration å·¥ä½œæµ**
```bash
# 1. ç”Ÿæˆ migration
pnpm db:generate

# 2. åº”ç”¨åˆ°æœ¬åœ°
pnpm db:migrate:local

# 3. åº”ç”¨åˆ°ç”Ÿäº§
pnpm db:migrate:prod

# 4. æŸ¥çœ‹æ•°æ®åº“
pnpm db:studio
```

---

### 3. Cloudflare Workers & R2

#### **è·å–ç¯å¢ƒå˜é‡**
```typescript
import { getCloudflareContext } from "@opennextjs/cloudflare";

const { env } = await getCloudflareContext();
const apiKey = env.FAL_KEY;
const db = env.DB;
const r2 = env.FILES;
```

#### **R2 æ–‡ä»¶ä¸Šä¼ **
```typescript
// ä¸Šä¼ æ–‡ä»¶
await env.FILES.put(key, arrayBuffer, {
  httpMetadata: {
    contentType: file.type,
    cacheControl: "public, max-age=31536000",
  },
  customMetadata: {
    originalName: file.name,
    uploadedAt: new Date().toISOString(),
  }
});

// è¯»å–æ–‡ä»¶
const object = await env.FILES.get(key);
const arrayBuffer = await object.arrayBuffer();
```

#### **Remote Bindings (æœ¬åœ°å¼€å‘)**
```typescript
// next.config.ts
initOpenNextCloudflareForDev({
  experimental: {
    remoteBindings: true, // æœ¬åœ°è¿æ¥çœŸå® R2
  }
});
```

```jsonc
// wrangler.jsonc
{
  "r2_buckets": [
    {
      "bucket_name": "wild-voice-files",
      "binding": "FILES",
      "experimental_remote": true
    }
  ]
}
```

---

### 4. AI SDK (Vercel)

#### **é…ç½® Provider**
```typescript
import { createFal } from "@ai-sdk/fal";

const fal = createFal({
  apiKey: env.FAL_KEY
});
```

#### **Text-to-Speech**
```typescript
import { experimental_generateSpeech as generateSpeech } from 'ai';

const { audio } = await generateSpeech({
  model: fal.speech('fal-ai/minimax/speech-02-hd'),
  text: 'Hello, world!',
  providerOptions: {
    fal: {
      voice_setting: {
        voice_id: "Wise_Woman",
        speed: 1.0,
        vol: 1.0,
        pitch: 0,
        emotion: "happy"
      }
    }
  }
});

// å¤„ç†éŸ³é¢‘æ•°æ®
const audioBuffer = Buffer.from(audio.uint8Array);
```

#### **ä¸ºä»€ä¹ˆé€‰æ‹© AI SDKï¼Ÿ**
- âœ… ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºåˆ‡æ¢æä¾›å•†
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… æ”¯æŒå¤šä¸ª AI æä¾›å•†ï¼ˆFAL, OpenAI, ElevenLabs ç­‰ï¼‰
- âœ… é€šè¿‡ `providerOptions` è®¿é—®é«˜çº§å‚æ•°

---

### 5. API è®¾è®¡æ¨¡å¼

#### **ç»Ÿä¸€å“åº”æ ¼å¼**
```typescript
// src/lib/api-response.ts
export interface ApiResponse<T = any> {
  success: boolean;
  data: T | null;
  error: string | null;
  message?: string;
}

export function successResponse<T>(data: T, message?: string, status = 200) {
  return new Response(JSON.stringify({
    success: true,
    data,
    error: null,
    message
  }), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });
}

export function errorResponse(error: string, status = 400) {
  return new Response(JSON.stringify({
    success: false,
    data: null,
    error
  }), { status, headers: { 'Content-Type': 'application/json' } });
}
```

#### **é”™è¯¯å¤„ç†**
```typescript
// src/lib/api-error.ts
export default function handleApiError(error: unknown) {
  if (error instanceof z.ZodError) {
    const firstError = error.issues[0];
    return new Response(JSON.stringify({
      success: false,
      error: firstError.message,
      field: firstError.path.join(".")
    }), { status: 400 });
  }

  const message = error instanceof Error ? error.message : "Internal server error";
  return new Response(JSON.stringify({
    success: false,
    error: message
  }), { status: 500 });
}
```

#### **è®¤è¯ä¸­é—´ä»¶**
```typescript
const session = await getSession();
if (!session?.user) {
  return unauthorizedResponse();
}
```

---

### 6. æ¨¡å—åŒ–æ¶æ„

#### **åŠŸèƒ½æ¨¡å—ç»“æ„**
```
src/modules/
â”œâ”€â”€ voices/
â”‚   â””â”€â”€ schemas/
â”‚       â””â”€â”€ voice.schema.ts
â”œâ”€â”€ outputs/
â”‚   â””â”€â”€ schemas/
â”‚       â””â”€â”€ output.schema.ts
â””â”€â”€ auth/
    â””â”€â”€ schemas/
        â””â”€â”€ auth.schema.ts
```

#### **Schema å¯¼å‡ºç®¡ç†**
```typescript
// src/db/schema.ts
export { voicesSchema } from "@/modules/voices/schemas/voice.schema";
export { outputsSchema } from "@/modules/outputs/schemas/output.schema";
export { user, session } from "@/modules/auth/schemas/auth.schema";
```

---

### 7. å¼€å‘å·¥å…·

#### **REST Client (.http æ–‡ä»¶)**
```http
@baseUrl = http://localhost:3000
@sessionToken = your_session_token

### æµ‹è¯• GET
GET {{baseUrl}}/api/voices
Cookie: better-auth.session_token={{sessionToken}}

### æµ‹è¯• POST
POST {{baseUrl}}/api/tts
Cookie: better-auth.session_token={{sessionToken}}
Content-Type: application/json

{
  "text": "Hello",
  "voiceId": 1
}
```

---

## ğŸ¯ æ ¸å¿ƒå­¦ä¹ è¦ç‚¹

### 1. **Schema è®¾è®¡åŸåˆ™**
- ä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µåï¼ˆcamelCaseï¼‰
- å¤–é”®å…³è”è¦è®¾ç½® `onDelete` è¡Œä¸º
- æ—¶é—´æˆ³ä½¿ç”¨ `mode: "timestamp"` å’Œ `.defaultNow()`
- å¿…å¡«å­—æ®µç”¨ `.notNull()`ï¼Œå¯é€‰å­—æ®µä¸åŠ 

### 2. **API æœ€ä½³å®è·µ**
- ç»Ÿä¸€å“åº”æ ¼å¼
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- è®¤è¯æ£€æŸ¥æ”¾åœ¨æœ€å‰é¢
- æ•°æ®éªŒè¯ä½¿ç”¨ Zod
- è¿”å›æ­£ç¡®çš„ HTTP çŠ¶æ€ç ï¼ˆ200, 201, 400, 401, 404, 500ï¼‰

### 3. **ç±»å‹å®‰å…¨**
- ä½¿ç”¨ Drizzle çš„ç±»å‹æ¨æ–­ï¼š`$inferSelect`, `$inferInsert`
- Zod schema è‡ªåŠ¨ç”Ÿæˆï¼š`createInsertSchema`, `createSelectSchema`
- TypeScript ç±»å‹å¯¼å‡ºï¼š`export type Voice = typeof voicesSchema.$inferSelect`

### 4. **æ–‡ä»¶å¤„ç†**
- `Uint8Array` â†’ `Buffer.from()` â†’ `Response`
- R2 ä¸Šä¼ ä½¿ç”¨ `File` æˆ– `ArrayBuffer`
- è®¾ç½®æ­£ç¡®çš„ `Content-Type` å’Œ `Content-Disposition`

### 5. **ç¯å¢ƒç®¡ç†**
- æœ¬åœ°å¼€å‘ï¼š`.dev.vars` + Remote Bindings
- ç”Ÿäº§ç¯å¢ƒï¼š`wrangler secret put`
- é€šè¿‡ `getCloudflareContext()` è®¿é—®ç¯å¢ƒå˜é‡

---

## ğŸš€ å®ç°çš„å®Œæ•´åŠŸèƒ½

### Voice Library (è¯­éŸ³åº“)
- âœ… æ•°æ®åº“è¡¨è®¾è®¡
- âœ… GET /api/voices - è·å–åˆ—è¡¨
- âœ… POST /api/voices - åˆ›å»ºå£°éŸ³
- âœ… å…¬å…±/ç§æœ‰æƒé™æ§åˆ¶

### Text-to-Speech (æ–‡å­—è½¬è¯­éŸ³)
- âœ… AI SDK + FAL é›†æˆ
- âœ… æ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼ˆspeed, pitch, emotionï¼‰
- âœ… R2 å­˜å‚¨
- âœ… æ•°æ®åº“è®°å½•
- âœ… è¿”å›å¯è®¿é—®çš„éŸ³é¢‘ URL

### Outputs (ç”Ÿæˆè®°å½•)
- âœ… æ•°æ®åº“è¡¨è®¾è®¡
- âœ… ä¿å­˜ TTS è®°å½•
- âœ… å…³è”ç”¨æˆ·å’Œè¯­éŸ³

---

## ğŸ’¡ è§£å†³çš„æŠ€æœ¯éš¾ç‚¹

1. **AI SDK åœ¨ Cloudflare Workers ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡**
   - é—®é¢˜ï¼šAI SDK é»˜è®¤ä» `process.env` è¯»å–
   - è§£å†³ï¼šä½¿ç”¨ `createFal({ apiKey: env.FAL_KEY })`

2. **æœ¬åœ° R2 å¼€å‘æ— å…¬å…± URL**
   - é—®é¢˜ï¼šæœ¬åœ° R2 æ˜¯æ¨¡æ‹Ÿçš„ï¼Œæ— æ³•ç”Ÿæˆå…¬å…± URL
   - è§£å†³ï¼šå¯ç”¨ Remote Bindingsï¼Œç›´æ¥è¿æ¥çœŸå® R2

3. **éŸ³é¢‘æ•°æ®ç±»å‹è½¬æ¢**
   - é—®é¢˜ï¼š`GeneratedAudioFile` ä¸èƒ½ç›´æ¥ä¼ ç»™ `Response`
   - è§£å†³ï¼š`Buffer.from(audio.uint8Array)`

4. **æ•°æ®éªŒè¯ä¸ç±»å‹å®‰å…¨**
   - é—®é¢˜ï¼šéœ€è¦è¿è¡Œæ—¶éªŒè¯å’Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
   - è§£å†³ï¼šDrizzle + Zod ç»“åˆï¼Œè‡ªåŠ¨ç”ŸæˆéªŒè¯ schema

---

## ğŸ“– æ¨èå»¶ä¼¸å­¦ä¹ 

1. **Drizzle ORM é«˜çº§æŸ¥è¯¢**
   - Joins
   - Transactions
   - Prepared Statements

2. **AI SDK å…¶ä»–åŠŸèƒ½**
   - `streamText` - æµå¼æ–‡æœ¬ç”Ÿæˆ
   - `generateObject` - ç»“æ„åŒ–æ•°æ®ç”Ÿæˆ
   - Tool Calling

3. **Cloudflare Workers**
   - Durable Objects
   - KV Storage
   - Queues

4. **Next.js 15 æ–°ç‰¹æ€§**
   - Server Actions
   - Partial Prerendering
   - Turbopack

---

_ç”Ÿæˆæ—¶é—´: 2025-10-05_
